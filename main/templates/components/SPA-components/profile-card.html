{% load static %}

<div class="profile-card-container">
  <div class="profile-card-content">
    <div class="profile-card-right">
      <form>
        {% csrf_token %}
      <div class="profile-viewer">
        {% if is_owner %}
          <label for="profilePicInput" style="cursor:pointer;">
            <img 
              id="profilePic"
              src="{% if profile_user.profile_pic and profile_user.profile_pic.url %}{{ profile_user.profile_pic.url }}{% else %}https://cdn-icons-png.flaticon.com/128/149/149071.png{% endif %}"
              alt="Profile Picture">
          </label>
          <input type="file" id="profilePicInput" name="profile_pic" accept="image/*" hidden>
          <p id="uploadMessage" style="margin-top: 10px; font-size: 14px;"></p>
        {% else %}
          <img 
            src="{% if profile_user.profile_pic and profile_user.profile_pic.url %}{{ profile_user.profile_pic.url }}{% else %}https://cdn-icons-png.flaticon.com/128/149/149071.png{% endif %}"
            alt="Profile Picture">
        {% endif %}

        <h1 class="profile-name">{{ profile_user.firstname }} {{ profile_user.lastname }}</h1>

        {% if not is_owner %}
          <div class="chat-btn-container">
            <a href="{% url 'chat_with_user' profile_user.uid %}" class="chat-btn">üí¨ Chat</a>
          </div>
        {% endif %}
      </div>
      </form>
      <div class="contents-container" id="profileInfo">
        <label>Address</label>
        <p id="addressDisplay">{{ profile_bio.address|default:"Not provided" }}</p>
        {% if is_owner %}
          <input type="text" id="addressInput" value="{{ profile_bio.address }}" style="display:none;">
        {% endif %}

        <label>Email</label>
        <p>{{ profile_user.email }}</p>

        <label>Bio</label>
        <p id="bioDisplay">{{ profile_bio.bio|default:"No bio available" }}</p>
        {% if is_owner %}
          <textarea id="bioInput" style="display:none;">{{ profile_bio.bio }}</textarea>
        {% endif %}

        {% if is_owner %}
          <div class="button-group">
            <button id="editBtn">Edit</button>
            <button id="saveBtn" style="display: none;">Save</button>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const input = document.getElementById("profilePicInput");
  const preview = document.getElementById("profilePic");
  const uploadMessage = document.getElementById("uploadMessage");

  if (!input) return;

  input.addEventListener("change", () => {
    const file = input.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append("profile_pic", file);

    fetch("{% url 'update_profile_pic' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
      },
      body: formData,
    })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          preview.src = data.profile_pic_url;
          uploadMessage.textContent = "‚úÖ Profile picture updated!";
          uploadMessage.style.color = "green";
        } else {
          uploadMessage.textContent = "‚ùå " + data.error;
          uploadMessage.style.color = "red";
        }
      })
      .catch(() => {
        uploadMessage.textContent = "‚ùå Upload failed. Try again.";
        uploadMessage.style.color = "red";
      });
  });
});
</script>
